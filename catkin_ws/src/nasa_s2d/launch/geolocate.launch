<?xml version="1.0" encoding="UTF-8"?>
<launch>

    <arg name="show3d"          default="false" />
    <arg name="heading"         default="" />
    <arg name="altitude"        default="" />
    <arg name="camera_name"     default="camera" />
    <arg name="tracks_topic"    default="tracks" />

    <!-- show3d:          Show the rviz vizualization of the geolocated targets -->
    <!-- heading:         Optional ENU heading overriding (for bad compass data)-->
    <!-- altitude:        Optional ENU altitude offset                          -->
    <!-- camera_name:     Camera name to subscribe to the camera_info of        -->
    <!-- tracks_topic:    topic name of R-RANSAC output tracks                  -->

    <!-- ###################################################################### -->

    
    <!-- Broadcast coordinate transformations specific to Sully -->
    <!-- Needed for geolocation, useful for RVIZ visualization -->
    <include file="$(find nasa_s2d)/launch/tf_frames.launch" />


    <!-- connect the geolocator to the output of visual_mtt -->
    <remap from="pose"  to="mavros/local_position/pose" />
    <include file="$(find flat_earth_geolocation)/launch/geolocate.launch">
        <arg name="show3d" value="false" />
        <arg name="camera_name" value="$(arg camera_name)" />
        <arg name="tracks_topic" value="$(arg tracks_topic)" />

        <!-- tf frames -->
        <arg name="result_frame" value="map" />
        <arg name="camera_frame" value="camera" />
    </include>

    <!-- rviz 3d visualization of geolocated tracks -->
    <group if="$(arg show3d)">

        <node pkg="flat_earth_geolocation" type="plotter" name="plotter" output="screen">
            <remap from="tracks" to="tracks3d" />
        </node>

        <node pkg="rviz" type="rviz" name="rviz" args="-d $(find nasa_s2d)/rviz/s2d_geolocation.rviz" />
    </group>


    <!-- Call ROS Service to set UAV position offsets and heading override -->
    <group if="$(eval str(arg('heading')) is not '' or str(arg('altitude')) is not '')">

        <arg     if="$(eval str(arg('heading')) is not '')" name="hdg" value="$(arg heading)" />
        <arg unless="$(eval str(arg('heading')) is not '')" name="hdg" value="360" /> <!-- 360 prevents overriding -->

        <arg     if="$(eval str(arg('altitude')) is not '')" name="alt" value="$(arg altitude)" />
        <arg unless="$(eval str(arg('altitude')) is not '')" name="alt" value="0" />

        <node pkg="rosservice" type="rosservice" name="srv_uav_pose"
            args="call --wait /sully_tf_frames/set_uav_pose '{ heading_enu: $(arg hdg), offset_enu: { x: 0, y: 0, z: $(arg alt)} }'" />
    </group>
</launch>